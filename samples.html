<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Samples</title>
    <link rel="stylesheet" href="styles/06_samples.css">
    <link rel="stylesheet" href="styles/02_top-toolbar.css">
    <link rel="stylesheet" href="styles/01_search-bar.css">
</head>

<aside id="disclaimer">
    *NONE OF THE DATA ON THIS SITE IS REAL AND IS ONLY USED AS A DEMONSTRATION OF HOW THE SITE WORKS*
</aside>

<body>
    <header>
        <a href="index.html" id="logo">Alpha-Ionix</a>
        <!-- Navigation Toolbar -->
        <nav>
            <ul>
                <!-- Login Dropdown -->
                <li><a href="#" id="login-btn">Login</a>
                    <ul id="dropdown-menu" class="hidden">
                        <li><a href="sample-login.html">Sample Login</a></li>
                    </ul>
                </li>

                <!-- Analysis Dropdown -->
                <li><a href="#" id="login-btn">Analysis</a>
                    <ul id="dropdown-menu" class="hidden">
                        <li><a href="batches.html">Batches</a></li>
                        <li><a href="samples.html">Samples</a></li>
                        <li><a href="workorders.html">Workorders</a></li>
                    </ul>
                </li>

                <!-- Attributes Dropdown -->
                <li><a href="#" id="login-btn">Sample Attributes</a>
                    <ul id="dropdown-menu" class="hidden">
                        <li><a href="benchsheets.html">BenchSheets</a></li>
                        <li><a href="container-types.html">Containers</a></li>
                        <li><a href="equipment.html">Equipment</a></li>
                        <li><a href="hold-time.html">Hold Times</a></li>
                        <li><a href="matrix-types.html">Matrix Types</a></li>
                        <li><a href="reports.html">Reports</a></li>
                        <li><a href="sample-types.html">Sample Types</a></li>
                        <li><a href="standards.html">Standards</a></li>
                        <li><a href="test-code-table.html">Test Codes</a></li>
                        <li><a href="qualifiers.html">Qualifiers</a></li>
                        <li><a href="condition-codes.html">Condition Codes</a></li>
                    </ul>
                </li>

                <!-- Clients Dropdown -->
                <li><a href="#" id="clients-btn">Clients</a>
                    <ul id="dropdown-menu" class="hidden">
                        <li><a href="client-by-name.html">Client by Name</a></li>
                        <li><a href="client-by-site.html">Client by Site</a></li>
                        <li><a href="client-profile.html">Client Profiles</a></li>
                    </ul>
                </li>
    
                <!-- Users Dropdown -->
                <li><a href="#" id="settings-btn">Settings</a>
                    <ul id="dropdown-menu" class="hidden">
                        <li><a href="account-settings.html">Account Settings</a></li>
                        <li><a href="app-settings.html">Application Settings</a></li>
                        <li><a href="users.html">Users</a></li>
                        <li><a href="user-role-management.html">Roles</a></li>
                        <li><a href="help.html">Help</a></li>
                    </ul>
                </li>
            </ul>
        </nav>
    </header>

    <aside id="toolbar">
        <ul>
            <li><a href="compliance.html">Compliance</a></li>
            <li><a href="chemicials.html">Chemicals</a></li>
            <li><a href="procedures.html">Procedures</a></li> 
        </ul>
        <!-- Search Bar -->
<div id="search-container">
    <input type="text" id="search-bar" placeholder="Search..." />
    <button id="search-button">üîç</button>
</div>
    </aside>

    <main>
        <section id="samples">
            <h2>Samples
                <button id="new-batch">Create New Batch</button>
            </h2>

            <div id="tab-container">
                <button class="tab-button active" data-tab="samples">Samples</button>
                <button class="tab-button" data-tab="qc-samples">QC Samples</button>
            </div>            

            <!-- Table to display samples -->
            <div class="table-container">
            <table id="sample-table">
                <thead>
                    <tr>
                        <th>Sample ID</th>
                        <th>Workorder ID</th>
                        <th>Sample Type</th>
                        <th>Client Profile</th>
                        <th>Facility Name</th>
                        <th>Workorder Desc</th>
                        <th>Collector Name</th>
                        <th>Received By</th>
                        <th>Date Received</th>
                        <th>Collect Date</th>
                        <th>Analysis</th>
                        <th>Hold Time</th>
                        <th>Due Date</th>
                        <th>Sample Desc</th>
                        <th>Analytes</th>
                        <th>Status</th>
                        <th>Actions</th> <!-- New column for delete button -->
                        <!-- Add other columns as needed -->
                    </tr>
                </thead>
                <tbody>
                    <!-- Table rows will be added dynamically -->
                </tbody>
            </table>
        </div>
        </section>
    </main>
   
    <script>
        import { loadData, saveData } from './data-handler.js';

window.onload = async function () {
    const sampleDataArray = await loadData('sampleDataArray') || [];
    const workordersArray = await loadData('workordersArray') || [];
    const sampleStatusMap = await loadData('sampleStatusMap') || {};
    const tableBody = document.querySelector("#sample-table tbody");

    // Populate the table with sample data
    if (sampleDataArray.length > 0) {
        sampleDataArray.forEach((sampleData) => {
            const workorder = workordersArray.find(wo => wo.samples.some(s => s.id === sampleData.id));
            const workorderID = workorder ? workorder.id : "N/A";
            const status = sampleStatusMap[sampleData.id] || "In Progress";

            const row = document.createElement("tr");
            row.innerHTML = `
                <td><a href="sample-details.html?id=${sampleData.id}">${sampleData.id}</a></td>
                <td>${workorderID}</td>
                <td>${sampleData.sampleType || "N/A"}</td>
                <td>${sampleData.clientProfile || "N/A"}</td>
                <td>${sampleData.facilityId || "N/A"}</td>
                <td>${sampleData.workorderDescription || "N/A"}</td>
                <td>${sampleData.collectorName || "N/A"}</td>
                <td>${sampleData.receivedBy || "N/A"}</td>
                <td>${sampleData.dateReceived || "N/A"}</td>
                <td>${sampleData.collectDate || "N/A"}</td>
                <td>${sampleData.analysis || "N/A"}</td>
                <td>${sampleData.holdTime || "N/A"}</td>
                <td>${sampleData.dueDate || "N/A"}</td>
                <td>${sampleData.sampleDescription || "N/A"}</td>
                <td>${sampleData.analytes?.length > 0 ? sampleData.analytes.join(", ") : "N/A"}</td>
                <td>${status}</td>
                <td><button class="delete-btn" data-sample-id="${sampleData.id}">Delete</button></td>
            `;
            tableBody.appendChild(row);
        });
        console.log("Sample table populated successfully.");
    } else {
        console.log("No sample data found.");
    }

    // Initialize functionalities
    initializeTabFiltering();
    initializeSorting();
    initializeDeleteFunctionality();
};

async function initializeDeleteFunctionality() {
    const tableBody = document.querySelector("#sample-table tbody");

    tableBody.addEventListener("click", async (event) => {
        if (event.target.classList.contains("delete-btn")) {
            const sampleID = event.target.dataset.sampleId;
            console.log(`Delete button clicked for Sample ID: ${sampleID}`);

            let sampleDataArray = await loadData("sampleDataArray") || [];

            if (!sampleDataArray.some(sample => sample.id === sampleID)) {
                console.error(`Sample ID ${sampleID} not found.`);
                return;
            }

            // Remove the sample and update storage
            sampleDataArray = sampleDataArray.filter(sample => sample.id !== sampleID);
            await saveData("sampleDataArray", sampleDataArray);

            const rowToRemove = event.target.closest("tr");
            if (rowToRemove) {
                rowToRemove.remove();
                console.log(`Row for Sample ID ${sampleID} successfully removed.`);
            } else {
                console.error("Could not find the row to remove.");
            }

            updateTableView();
        }
    });
}

function initializeTabFiltering() {
    const tabs = document.querySelectorAll(".tab-button");
    const tableBody = document.querySelector("#sample-table tbody");

    tabs.forEach(tab => {
        tab.addEventListener("click", () => {
            const tabType = tab.getAttribute("data-tab");
            const allRows = Array.from(tableBody.querySelectorAll("tr"));

            tabs.forEach(t => t.classList.remove("active"));
            tab.classList.add("active");

            allRows.forEach(row => {
                const sampleType = row.querySelectorAll("td")[2]?.textContent.trim();
                row.style.display = 
                    (tabType === "samples" && sampleType === "SAM") ||
                    (tabType === "qc-samples" && sampleType !== "SAM") ? "" : "none";
            });
        });
    });

    document.querySelector(".tab-button.active").click();
}

function updateTableView() {
    const activeTab = document.querySelector(".tab-button.active");
    if (activeTab) activeTab.click();
}

function initializeSorting() {
    const table = document.querySelector("#sample-table");
    const headers = table.querySelectorAll("th");
    const tableBody = table.querySelector("tbody");

    headers.forEach((header, columnIndex) => {
        const dropdown = document.createElement("div");
        dropdown.classList.add("dropdown");

        dropdown.innerHTML = `
            <span class="dropdown-arrow">&#x25BC;</span>
            <div class="dropdown-menu">
                <button class="sort-asc">Sort A-Z</button>
                <button class="sort-desc">Sort Z-A</button>
            </div>
        `;

        header.appendChild(dropdown);

        dropdown.querySelector(".sort-asc").addEventListener("click", () => {
            sortTable(columnIndex, true);
        });

        dropdown.querySelector(".sort-desc").addEventListener("click", () => {
            sortTable(columnIndex, false);
        });
    });
}

function sortTable(columnIndex, ascending) {
    const tableBody = document.querySelector("#sample-table tbody");
    const rows = Array.from(tableBody.querySelectorAll("tr"));

    rows.sort((rowA, rowB) => {
        const cellA = rowA.querySelectorAll("td")[columnIndex]?.textContent.trim().toLowerCase();
        const cellB = rowB.querySelectorAll("td")[columnIndex]?.textContent.trim().toLowerCase();

        if (cellA < cellB) return ascending ? -1 : 1;
        if (cellA > cellB) return ascending ? 1 : -1;
        return 0;
    });

    rows.forEach(row => tableBody.appendChild(row));
}

document.getElementById('new-batch').addEventListener('click', function() {
    window.location.href = 'create-batches.html';
});
    </script>
    
    <script type="module" src="scripts/data-handler.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/localforage/dist/localforage.min.js"></script>

        
</body>
</html>